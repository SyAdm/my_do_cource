---
- name: Step 1 - Building Project
  hosts: build
  become: yes

  tasks:
   - name: Update apt cache and install packages
      apt:
        name:
          - git
          - default-jdk
          - maven
        state: present
        update_cache: 'yes'

    - name: Clone sample Java WAR project
      git:
        repo: 'https://github.com/boxfuse/boxfuse-sample-java-war-hello.git'
        dest: /opt/boxfuse-sample
        version: master

    - name: Build project with Maven
      command: mvn -B package
      args:
        chdir: /opt/boxfuse-sample

    - name: Copy WAR file to deploy server
      synchronize:
        src: /opt/boxfuse-sample/target/hello-1.0.war
        dest: /opt/hello-1.0.war
        mode: pull
      delegate_to: 10.128.0.3

- name: Step 2 - Product Server
  hosts: prod
  become: 'yes'
  
  tasks:
    - name: Install Tomcat
      apt:
        name: tomcat9
        state: present
        update_cache: 'yes'

    - name: Ensure Tomcat service is started and enabled
      systemd:
        name: tomcat9
        state: started
        enabled: 'yes'


